<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICM Popup Module - jQuery Deferred Examples</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            line-height: 1.6;
        }
        .example-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .example-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover { background: #005a87; }
        .code-example {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #e7f3e7;
            border-left: 4px solid #4caf50;
        }
    </style>
</head>
<body>
    <h1>DICM Popup Module - jQuery Deferred Integration Examples</h1>
    
    <div class="example-section">
        <h3>1. Basic Promise-Based Popup Operations</h3>
        <p>Open and close popups with promise resolution:</p>
        
        <button onclick="example1()">Run Example 1</button>
        
        <div class="code-example">
// Example 1: Basic promise-based operations
function example1() {
    DICMPopupManager.openById('example-popup').then(function($popup) {
        console.log('Popup opened successfully:', $popup);
        
        // Auto-close after 2 seconds
        setTimeout(function() {
            DICMPopupManager.closeById('example-popup').then(function() {
                console.log('Popup closed successfully');
            });
        }, 2000);
    }).catch(function(error) {
        console.log('Failed to open popup:', error);
    });
}
        </div>
    </div>
    
    <div class="example-section">
        <h3>2. Chained Popup Operations</h3>
        <p>Chain multiple popup operations in sequence:</p>
        
        <button onclick="example2()">Run Example 2</button>
        
        <div class="code-example">
// Example 2: Chain multiple operations
function example2() {
    DICMPopupManager.chainOperations([
        { type: 'open', popupId: 'popup1' },
        { type: 'delay', duration: 1500 },
        { type: 'close', popupId: 'popup1' },
        { type: 'delay', duration: 500 },
        { type: 'open', popupId: 'popup2' },
        { type: 'delay', duration: 1500 },
        { type: 'close', popupId: 'popup2' }
    ]).then(function() {
        console.log('All chained operations completed successfully');
    }).catch(function(error) {
        console.log('Chain operation failed:', error);
    });
}
        </div>
    </div>
    
    <div class="example-section">
        <h3>3. Conditional Popup Opening</h3>
        <p>Open popups based on dynamic conditions:</p>
        
        <button onclick="example3()">Run Example 3</button>
        
        <div class="code-example">
// Example 3: Conditional popup opening
function example3() {
    // Check user preferences before opening
    DICMPopupManager.openConditional('user-popup', function() {
        // This could check localStorage, cookies, user status, etc.
        const userLoggedIn = Math.random() > 0.5; // Random for demo
        console.log('User logged in check:', userLoggedIn);
        return userLoggedIn;
    }).then(function($popup) {
        console.log('Conditional popup opened for logged-in user');
    }).catch(function(error) {
        console.log('Popup not opened - condition not met:', error);
    });
}
        </div>
    </div>
    
    <div class="example-section">
        <h3>4. Animation Promise Helpers</h3>
        <p>Use jQuery extensions for promise-based animations:</p>
        
        <button onclick="example4()">Run Example 4</button>
        
        <div class="code-example">
// Example 4: Custom animations with promises
function example4() {
    const $element = $('#demo-element');
    
    // Chain animations with promises
    $element.animateWithPromise({ left: '200px' }, 500)
        .then(function() {
            return $element.animateWithPromise({ top: '100px' }, 500);
        })
        .then(function() {
            return $element.transitionWithPromise('highlight', 300);
        })
        .then(function() {
            console.log('All animations completed');
            // Reset position
            return $element.animateWithPromise({ left: '0px', top: '0px' }, 500);
        })
        .then(function() {
            $element.removeClass('highlight');
            console.log('Element reset to original position');
        });
}
        </div>
    </div>
    
    <div class="example-section">
        <h3>5. Advanced Error Handling</h3>
        <p>Handle errors gracefully with jQuery Deferred:</p>
        
        <button onclick="example5()">Run Example 5</button>
        
        <div class="code-example">
// Example 5: Error handling and recovery
function example5() {
    // Try to open a non-existent popup
    DICMPopupManager.openById('non-existent-popup').then(function($popup) {
        console.log('This should not execute');
    }).catch(function(error) {
        console.log('Expected error caught:', error);
        
        // Fallback: open a different popup
        return DICMPopupManager.openById('fallback-popup');
    }).then(function($popup) {
        if ($popup) {
            console.log('Fallback popup opened successfully');
            
            // Close after 2 seconds
            setTimeout(function() {
                DICMPopupManager.closeById('fallback-popup');
            }, 2000);
        }
    }).catch(function(finalError) {
        console.log('Final fallback also failed:', finalError);
    });
}
        </div>
    </div>
    
    <div class="example-section">
        <h3>6. Multiple Popup Coordination</h3>
        <p>Coordinate multiple popups with jQuery.when():</p>
        
        <button onclick="example6()">Run Example 6</button>
        
        <div class="code-example">
// Example 6: Multiple popup coordination
function example6() {
    // Open multiple popups simultaneously
    $.when(
        DICMPopupManager.openById('popup-left'),
        DICMPopupManager.openById('popup-right')
    ).then(function(leftPopup, rightPopup) {
        console.log('Both popups opened:', leftPopup, rightPopup);
        
        // Wait 3 seconds, then close both
        setTimeout(function() {
            $.when(
                DICMPopupManager.closeById('popup-left'),
                DICMPopupManager.closeById('popup-right')
            ).then(function() {
                console.log('Both popups closed successfully');
            });
        }, 3000);
    }).catch(function(error) {
        console.log('Failed to open one or more popups:', error);
    });
}
        </div>
    </div>
    
    <div style="margin-top: 40px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
        <h3>Usage in WordPress/Divi:</h3>
        <p>To use these patterns in your Divi popup modules:</p>
        <ol>
            <li>Ensure jQuery is loaded on your page</li>
            <li>The <code>DICMPopupManager</code> object will be globally available</li>
            <li>Use the popup ID from your Divi module settings</li>
            <li>All methods return jQuery promises for chaining operations</li>
            <li>Events are automatically tracked (Google Analytics, Facebook Pixel)</li>
        </ol>
    </div>

    <!-- Demo elements for animation examples -->
    <div id="demo-element" style="position: relative; width: 50px; height: 50px; background: #3498db; margin: 20px 0;"></div>
    
    <style>
        .highlight { 
            background-color: #f39c12 !important; 
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.7);
        }
    </style>

    <script>
        // Mock DICMPopupManager for demo purposes
        // In real implementation, this would be loaded from frontend-deferred.js
        window.DICMPopupManager = {
            openById: function(id) {
                const deferred = $.Deferred();
                console.log('Mock: Opening popup', id);
                setTimeout(() => {
                    if (id === 'non-existent-popup') {
                        deferred.reject('Popup not found');
                    } else {
                        deferred.resolve($('<div>').attr('id', id));
                    }
                }, 100);
                return deferred.promise();
            },
            
            closeById: function(id) {
                const deferred = $.Deferred();
                console.log('Mock: Closing popup', id);
                setTimeout(() => deferred.resolve(), 100);
                return deferred.promise();
            },
            
            chainOperations: function(operations) {
                const deferred = $.Deferred();
                console.log('Mock: Chaining operations', operations);
                setTimeout(() => deferred.resolve(), 500);
                return deferred.promise();
            },
            
            openConditional: function(id, conditionFn) {
                const deferred = $.Deferred();
                const result = conditionFn();
                if (result) {
                    setTimeout(() => deferred.resolve($('<div>').attr('id', id)), 100);
                } else {
                    setTimeout(() => deferred.reject('Condition not met'), 100);
                }
                return deferred.promise();
            }
        };
        
        // Add jQuery promise extensions for demo
        $.fn.animateWithPromise = function(properties, duration) {
            const deferred = $.Deferred();
            this.animate(properties, {
                duration: duration || 400,
                complete: () => deferred.resolve(this)
            });
            return deferred.promise();
        };
        
        $.fn.transitionWithPromise = function(className, duration) {
            const deferred = $.Deferred();
            this.addClass(className);
            setTimeout(() => deferred.resolve(this), duration || 300);
            return deferred.promise();
        };
        
        // Example functions
        function example1() {
            DICMPopupManager.openById('example-popup').then(function($popup) {
                console.log('✅ Popup opened successfully:', $popup);
                setTimeout(function() {
                    DICMPopupManager.closeById('example-popup').then(function() {
                        console.log('✅ Popup closed successfully');
                    });
                }, 2000);
            }).catch(function(error) {
                console.log('❌ Failed to open popup:', error);
            });
        }
        
        function example2() {
            DICMPopupManager.chainOperations([
                { type: 'open', popupId: 'popup1' },
                { type: 'delay', duration: 1500 },
                { type: 'close', popupId: 'popup1' },
                { type: 'delay', duration: 500 },
                { type: 'open', popupId: 'popup2' },
                { type: 'delay', duration: 1500 },
                { type: 'close', popupId: 'popup2' }
            ]).then(function() {
                console.log('✅ All chained operations completed successfully');
            }).catch(function(error) {
                console.log('❌ Chain operation failed:', error);
            });
        }
        
        function example3() {
            DICMPopupManager.openConditional('user-popup', function() {
                const userLoggedIn = Math.random() > 0.5;
                console.log('🔍 User logged in check:', userLoggedIn);
                return userLoggedIn;
            }).then(function($popup) {
                console.log('✅ Conditional popup opened for logged-in user');
            }).catch(function(error) {
                console.log('ℹ️ Popup not opened - condition not met:', error);
            });
        }
        
        function example4() {
            const $element = $('#demo-element');
            
            $element.animateWithPromise({ left: '200px' }, 500)
                .then(function() {
                    console.log('✅ Step 1: Moved right');
                    return $element.animateWithPromise({ top: '100px' }, 500);
                })
                .then(function() {
                    console.log('✅ Step 2: Moved down');
                    return $element.transitionWithPromise('highlight', 300);
                })
                .then(function() {
                    console.log('✅ Step 3: Highlighted');
                    return $element.animateWithPromise({ left: '0px', top: '0px' }, 500);
                })
                .then(function() {
                    $element.removeClass('highlight');
                    console.log('✅ Animation sequence completed - element reset');
                });
        }
        
        function example5() {
            DICMPopupManager.openById('non-existent-popup').then(function($popup) {
                console.log('This should not execute');
            }).catch(function(error) {
                console.log('✅ Expected error caught:', error);
                return DICMPopupManager.openById('fallback-popup');
            }).then(function($popup) {
                if ($popup) {
                    console.log('✅ Fallback popup opened successfully');
                    setTimeout(function() {
                        DICMPopupManager.closeById('fallback-popup');
                    }, 2000);
                }
            }).catch(function(finalError) {
                console.log('❌ Final fallback also failed:', finalError);
            });
        }
        
        function example6() {
            $.when(
                DICMPopupManager.openById('popup-left'),
                DICMPopupManager.openById('popup-right')
            ).then(function(leftPopup, rightPopup) {
                console.log('✅ Both popups opened:', leftPopup, rightPopup);
                
                setTimeout(function() {
                    $.when(
                        DICMPopupManager.closeById('popup-left'),
                        DICMPopupManager.closeById('popup-right')
                    ).then(function() {
                        console.log('✅ Both popups closed successfully');
                    });
                }, 3000);
            }).catch(function(error) {
                console.log('❌ Failed to open one or more popups:', error);
            });
        }
    </script>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>
</html>
